<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.ico">
  <meta name="keyword" content="ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠ,XYM,Symbol">
	<meta meta name="description" content="ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠ Monitorã¯xembook.tomatoãƒ¢ã‚¶ã‚¤ã‚¯ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¯è¦–åŒ–ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™">
	<link rel="canonical" href="https://ishidad2.github.io/2022-tomatina">
	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="@ishidad2">
	<meta name="twitter:title" content="ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠ Monitor">
	<meta name="twitter:description" content="ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠ Monitorã¯xembook.tomatoãƒ¢ã‚¶ã‚¤ã‚¯ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¯è¦–åŒ–ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™">
	<meta name="twitter:image" content="https://ishidad2.github.io/2022-tomatina/tomato.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="manifest" href="./manifest.json">
  <title>ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠ Monitor</title>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LS3K0HTFYK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LS3K0HTFYK');
</script>

<body>
  <header>
    <h1>ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠ Monitor</h1>
  </header>
  <section>
    <div class="container-fluid">
      <div class="row">
        <div class="tomatina-links">
          <ul>
            <li>ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠğŸ…ã£ã¦ãªã«ï¼ï¼Ÿ<a href="https://twitter.com/xembook/status/1555023490742652929" target="_blank" rel="noopener noreferrer">(@xembook)</a></li>
            <li>ã¨ã‚Šã‚ãˆãšã“ã‚Œã ã‘è¦‹ã¨ã‘ã°å¤§ä¸ˆå¤«ğŸ…<a href="https://twitter.com/hossiiii1/status/1564359038703308800" target="_blank" rel="noopener noreferrer">(ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠã‚¤ãƒ™ãƒ³ãƒˆã¾ã¨ã‚)</a></li>
            <li>ğŸ…ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠäº¤æ›æ‰€ğŸ…<a href="https://tomato-dex.herokuapp.com/" target="_blank" rel="noopener noreferrer">(@toshiya_ma)</a></li>
            <li>Tomatina Walletã§ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠğŸ…<a href="https://twitter.com/mikunNEM/status/1558385436950536192" target="_blank" rel="noopener noreferrer">(@mikunNEM)</a></li>
            <li>toshi.tomatoğŸ…ã‚’æ‰‹ã«å…¥ã‚Œã‚ˆã†ï¼<a href="https://twitter.com/toshiya_ma/status/1560514223322681352" target="_blank" rel="noopener noreferrer">(@toshiya_ma)</a></li>
            <li>æ³•å®šé€šè²¨ãŒãƒˆãƒãƒˆğŸ…ã«ãªã£ãŸæ™‚ï¼ï¼Ÿ<a href="https://twitter.com/subarumanSP/status/1560509786822545409" target="_blank" rel="noopener noreferrer">(@subarumanSP)</a></li>
            <li>ã‚ãªãŸãŒãƒˆãƒãƒˆã¨è¨€ã£ãŸã‹ã‚‰8æœˆ31æ—¥ã¯ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠè¨˜å¿µæ—¥ğŸ…ğŸ˜<a href="https://twitter.com/HANABATA_KE/status/1559803077292863488" target="_blank" rel="noopener noreferrer">(@HANABATA_KE)</a></li>
            <li>NFTDriveEXã§ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠğŸ…<a href="https://twitter.com/EUFjZEyIuzS9rIi/status/1560656061236776966" target="_blank" rel="noopener noreferrer">(@EUFjZEyIuzS9rIi)</a></li>
            <li>VRç©ºé–“ã§ã‚‚ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠğŸ…<a href="https://twitter.com/feiton81118/status/1561563678994219009" target="_blank" rel="noopener noreferrer">(@feiton81118)</a></li>
            <li>TokenLiveã§ã‚‚ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠğŸ…<a href="https://twitter.com/hossiiii1/status/1563431810553372672" target="_blank" rel="noopener noreferrer">(@hossiiii1)</a></li>
            <li>ğŸ…ãƒˆãƒãƒˆäº¤æ›æ‰€çˆ†èª•ğŸ…<a href="https://twitter.com/toshiya_ma/status/1563070724239421441" target="_blank" rel="noopener noreferrer">(@toshiya_ma)</a></li>
            <li>ğŸ…ã®æµã¿ğŸ›GET!<a href="https://twitter.com/KisekinoF/status/1563069948368658433" target="_blank" rel="noopener noreferrer">(@KisekinoF)</a></li>
            <li>ã€Arcanaå¤ç¥­ã‚Šã€‘<a href="https://twitter.com/x_matsuno/status/1562922958137757698" target="_blank" rel="noopener noreferrer">(@x_matsuno)</a></li>
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col col-sm-12 col-md-11 col-lg-8">
          <div class="date-area">
            ğŸ…ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚°ãƒ©ãƒ• (<span id="tomato_graph_update">****</span> æ›´æ–°)
          </div>
          <div id="loading_chart" style="padding: 5px 2%">
            <img src="./loading-s-17.gif" alt="">
          </div>
          <canvas id="myChart" height="120"></canvas>
        </div>
        <div class="col">
          <div class="date-area">
            XEMBookğŸ…ãƒ©ãƒ³ã‚­ãƒ³ã‚° (<span id="ranking_update">****</span> æ›´æ–°)<br />
            ãƒ–ãƒ­ãƒƒã‚¯é«˜ï¼š<span id="block_height">****</span>
          </div>
          <div class="ranking">
            <div id="loading">
              <img src="./loading-s-17.gif" alt="">
            </div>
            <ul class="d-ranking-list" id="tomatoRanking">
            </ul>
          </div>
        </div>
        <!-- col end -->
      </div>
      <!-- row end -->
      <div class="row">
        <div class="col">
          <div class="date-area">
            ç¾åœ¨ã®ğŸ…ä¿æœ‰è€…æƒ…å ± (<span id="tomato_user_update">****</span> æ›´æ–°)
          </div>
          <div class="tomato-user">
            xembook.tomato ä¿æœ‰è€…äººæ•°ï¼š<span id="xembook_tomato_user">***</span> äºº
          </div>
          <div class="tomato-user">
            toshi.tomato ä¿æœ‰è€…äººæ•°ï¼š<span id="toshi_tomato_user">***</span> äºº (<a href="https://twitter.com/toshiya_ma/status/1560514223322681352" target="_blank" rel="noopener noreferrer">toshi.tomatoã¨ã¯ï¼Ÿï¼</a>)
          </div>
          <div class="tomato-user">
            toshi.tomato æœªä¿æœ‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
            <ul class="toshi-tomato-userl-ist" id="toshi_tomato_user_list">
            </ul>
          </div>
          <div class="memo">
            â€»ãƒˆãƒãƒ†ã‚£ãƒ¼ãƒŠ Monitorã¯ãƒ–ãƒ­ãƒƒã‚¯é«˜ï¼š<span id="startBlock"></span>ï½<span id="endBlock"></span>ã¾ã§ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ©ãƒ³ã‚­ã‚°ãƒ³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>
  </section>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script src="https://xembook.github.io/nem2-browserify/symbol-sdk-pack-2.0.0.js"></script>
  <script src="https://ishidad2.github.io/symbol-node-util-browserify/symbol-node-util-1.0.9.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
  <script>
    const { getActiveNode } = require("/node_modules/symbol-node-util");
    const {
      NetworkType,
      RepositoryFactoryHttp,
      MosaicId,
      TransactionGroup,
      Listener,
      ReceiptType,
      TransactionType,
      MosaicRestrictionEntryType,
      NamespaceId,AliasType
    } = require("/node_modules/symbol-sdk");
    (async()=>{
      let myChart;
      let labelVal = [dayjs().format('HH:mm:ss')];
      const maxPage = 30;
      const updatetime = 3;
      const colors = [
        { id: 1, backgroundColor: '#ff0000', borderColor: '#ff0000' }, //red
        { id: 2, backgroundColor: '#ff1493', borderColor: '#ff1493' }, //deeppink
        { id: 3, backgroundColor: '#8a2be2', borderColor: '#8a2be2' }, //blueviolet
        { id: 4, backgroundColor: '#4b0082', borderColor: '#4b0082' }, //indigo
        { id: 5, backgroundColor: '#800080', borderColor: '#800080' }, //purple
        { id: 6, backgroundColor: '#ffa500', borderColor: '#ffa500' }, //orange
        { id: 7, backgroundColor: '#f0e68c', borderColor: '#f0e68c' }, //khaki
        { id: 8, backgroundColor: '#a0522d', borderColor: '#a0522d' }, //sienna
        { id: 9, backgroundColor: '#f08080', borderColor: '#f08080' }, //lightcoral
        { id: 10, backgroundColor: '#006400', borderColor: '#006400' }, //darkgreen
        { id: 11, backgroundColor: '#00ced1', borderColor: '#00ced1' }, //darkturquoise
        { id: 12, backgroundColor: '#1e90ff', borderColor: '#1e90ff' }, //dodgerblue
        { id: 13, backgroundColor: '#0000ff', borderColor: '#0000ff' }, //blue
        { id: 14, backgroundColor: '#191970', borderColor: '#191970' }, //midnightblue
      ];
      let init = false;
      let graphArray = [];
      let useColors = [];
              
      // ===== æœ¬ç•ª ====
      const tomatinaMosaicId = "310378C18A140D1B";
      const toshiTomatoMosaicId = "613E6D0FC11F4530";
      const networkType = NetworkType.MAIN_NET;
      const startBlock = 1530966; //https://clock.sfn.tools/symbol?block=1530966&lang=ja
      const endBlock = 1532643;   //https://clock.sfn.tools/symbol?block=1532643&lang=ja
      const nodes = ["https://dual-1.nodes-xym.work:3001", "https://sym-main-01.opening-line.jp:3001", "https://sym-main-02.opening-line.jp:3001", "https://sym-main-03.opening-line.jp:3001"];
      
      // ******** ãƒ†ã‚¹ãƒˆç”¨ ********
      // const tomatinaMosaicId = "224CEE82F56D5A8B";
      // const toshiTomatoMosaicId = "16D70B79689070DB";
      // const networkType = NetworkType.TEST_NET;
      // const startBlock = 632642;
      // const endBlock = 640000;
      // const nodes = ["https://sym-test-01.opening-line.jp:3001"];

      const node = nodes[Math.floor(Math.random() * nodes.length)];
      
      console.log("æ¥ç¶š", node);
      $('#startBlock').text(startBlock);
      $('#endBlock').text(endBlock);

      const max = 40;
      const ctx = $('#myChart');

      const repo = new RepositoryFactoryHttp(node);
      const txRepo = repo.createTransactionRepository();
      const nsRepo = repo.createNamespaceRepository();
      const accountRepo = repo.createAccountRepository();
      const restrictRepo = repo.createRestrictionMosaicRepository();

      const epochAdjustment = await repo.getEpochAdjustment().toPromise();
      const wsEndpoint = node.replace('http', 'ws') + "/ws";
      const listener = new Listener(wsEndpoint,nsRepo,WebSocket);

      async function getTransfers(block){
        graphArray.forEach(data => {
          data.count = 0;
        });
        try {
          const tx = await txRepo.search({
            height: block.height.compact(),
            group: TransactionGroup.Confirmed
          }).toPromise();
          await parseTxs(tx.data);
        } catch (error) {
          console.error(error);
        }
      }

      async function parseTxs(txs){
        for(tx of txs){
          //ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®š
          if(tx.type === TransactionType.AGGREGATE_COMPLETE || tx.type === TransactionType.AGGREGATE_BONDED){
            //ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆã®å ´åˆã€å†…éƒ¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†å–å¾—
            const reTx = await txRepo.getTransaction(
              tx.transactionInfo.hash,
              TransactionGroup.Confirmed
            ).toPromise();
            console.log("== aggregateTx ==")
            //ã“ã®é–¢æ•°ã‚’å†å¸°çš„ã«å‘¼ã³å‡ºã—
            parseTxs(reTx.innerTransactions);  //å†å¸°å‘¼ã³å‡ºã—
            console.log("-----------------")
          }else {
            if(tx.mosaics !== undefined){
              tx.mosaics.forEach(mosaic => {
                const index = graphArray.findIndex((u) => u.mosaic_id === mosaic.id.toHex());
                if(index > -1){
                  graphArray[index].count = graphArray[index].count+1;
                }
              });
            }
          }
        }
      }

      async function updateChart(block){
        if(myChart){
          const blockTime = dayjs((epochAdjustment * 1000) + block.timestamp.compact()).format("HH:mm:ss");
          console.log("blockTime", blockTime);
          let chartLabels = myChart.data.labels;
          let chartDatasets =  myChart.data.datasets;
          if( myChart.data.labels.length > max){
            chartLabels =  myChart.data.labels.slice( myChart.data.labels.length-max,  myChart.data.labels.length)
          }
          //ãƒ©ãƒ™ãƒ«æ›¸ãæ›ãˆ
          myChart.data.labels = [...chartLabels, blockTime];

          await getTransfers(block);

          myChart.data.datasets.forEach((dataset) => {
            if( dataset.data.length > max){
              dataset.data.shift();
            }
            const index = graphArray.findIndex((u) => u.name === dataset.label);
            if(index > -1){
              dataset.data.push(graphArray[index].count);
            }
          });
          myChart.update();
          $('#tomato_graph_update').text(dayjs().format('HH:mm:ss'));
          $('#block_height').text(block.height.compact());
        }
      }
      
      function drawChart(dataset){
        myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labelVal,
            datasets: dataset
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            },
          }
        });
        init = true;
        $('#tomato_graph_update').text(dayjs().format('HH:mm:ss'));
        $('#loading_chart').hide();
      }

      //ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
      function getBatchOfTransfers(){
        let pageNumber = 0;
        $('#loading').show();
        let rank = [];
        let timer = setInterval( async function(){
          pageNumber++;
          console.log("ãƒ©ãƒ³ã‚­ãƒ³ã‚°pageNumber", pageNumber);
          const criteria = {
            group: TransactionGroup.Confirmed,
            embedded: true,
            transferMosaicId: new MosaicId(tomatinaMosaicId),
            order: "desc",
            pageNumber: pageNumber,
            pageSize: 60,
          }
          const txs = await txRepo.search(criteria).toPromise();
          for(tx of txs.data){
            //æŒ‡å®šãƒ–ãƒ­ãƒƒã‚¯å†…ã®ğŸ…ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨ˆæ¸¬
            const block_height = tx.transactionInfo.height.compact();
            if(endBlock >= block_height && startBlock <= block_height){
              rank.push(tx.signer.address.plain());
            }
            lastHeight = tx.transactionInfo.height.compact();
          }

          console.log("ğŸ…å±¥æ­´å–å¾—é–‹å§‹" + dayjs().format(), txs.isLastPage, startBlock >= lastHeight, startBlock >= lastHeight);
          let tomatinaRanking=[];
          if (txs.isLastPage || startBlock >= lastHeight || maxPage <= pageNumber){
            clearInterval(timer);
            let rankings = {};
            for (let i = 0; i < rank.length; i++) {
              var elm = rank[i];
              rankings[elm] = (rankings[elm] || 0) + 1;
            }
            let result = Object.entries(rankings).map(([key, value]) => ({"address": key, "txNum": value}));

            tomatinaRanking = result.sort(function(a, b){
              return (a.txNum > b.txNum) ? -1 : 1;
            });
            $('#ranking_update').text(dayjs().format('HH:mm:ss'));
            $('#loading').hide();
          }
          $('#tomatoRanking').empty();
          tomatinaRanking.forEach((el) => {
            $('#tomatoRanking').append('<li class="d-rank">' + el.address + " (" + el.txNum + ')</li>');
          })
        },2500);
      }

      async function getTomatoUser(){
        let pageNumber = 0;
        let xembookTomatoUser = 0;
        let timer = setInterval( async function(){
          pageNumber++;
          console.log("getTomatoUser_pageNumber", pageNumber);
          let _mosaic_owned = await accountRepo.search(
            {
              pageNumber: pageNumber,
              pageSize: 60,
              mosaicId: new MosaicId(tomatinaMosaicId),
            }
          ).toPromise();
          xembookTomatoUser += _mosaic_owned.data.length;
          if (_mosaic_owned.isLastPage || maxPage <= pageNumber){
            clearInterval(timer);
            $('#xembook_tomato_user').text(xembookTomatoUser);
            $('#tomato_user_update').text(dayjs().format('HH:mm:ss'));
          }
        },2000);
      }

      async function getToshiTomatoUser(){
        let pageNumber = 0;
        let toshiTomatoUser = 0;
        let timer = setInterval( async function(){
          pageNumber++;
          console.log("getToshiTomatoUser_pageNumber", pageNumber);
          let _mosaic_owned = await accountRepo.search(
            {
              pageNumber: pageNumber,
              pageSize: 60,
              mosaicId: new MosaicId(toshiTomatoMosaicId),
            }
          ).toPromise();
          toshiTomatoUser += _mosaic_owned.data.length;
          if (_mosaic_owned.isLastPage || maxPage <= pageNumber){
            clearInterval(timer);
            $('#toshi_tomato_user').text(toshiTomatoUser);
            $('#tomato_user_update').text(dayjs().format('HH:mm:ss'));
          }
        },2000);
      }

      async function getTomatoUserList(){
        let pageNumber = 0;
        $('#tomatoRanking').empty();
        $('#toshi_tomato_user_list').empty();
        let timer = setInterval( async function(){
          pageNumber++;
          console.log("getTomatoUserList_pageNumber", pageNumber);
          let _mosaic_restriction = await restrictRepo.search(
            {
              pageNumber: pageNumber,
              pageSize: 60,
              mosaicId: new MosaicId(toshiTomatoMosaicId),
            }
          ).toPromise();
          _mosaic_restriction.data.forEach((restriction) => {
            if(restriction.entryType === MosaicRestrictionEntryType.ADDRESS){
              //ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±å–å¾—
              accountRepo.getAccountInfo(restriction.targetAddress).subscribe((accountInfo) => {
                let mosaic_flg = false;
                accountInfo.mosaics.forEach((mosaic) => {
                  if(mosaic.id.toHex() === toshiTomatoMosaicId){
                    mosaic_flg = true;
                  }
                });
                if(!mosaic_flg){
                  $('#toshi_tomato_user_list').append('<li class="address">@' + accountInfo.address.plain() + '</li>');
                }
              });
            }
          })
          
          if (_mosaic_restriction.isLastPage || maxPage <= pageNumber){
            $('#tomato_user_update').text(dayjs().format('HH:mm:ss'));
            clearInterval(timer);
          }
        },2000);
      }

      function getTomatoNamespace(){
        let pageNumber = 0;
        let mosaicIds=[];
        let old={};
        let timer = setInterval( async function(){
          pageNumber++;
          const nsInfo = await nsRepo.search(
            {
              pageNumber: pageNumber,
              pageSize: 60,
              aliasType: AliasType.Mosaic
            }
          ).toPromise();

          nsInfo.data.forEach((info) => {
            mosaicIds.push(info.alias.mosaicId);
          });
          if (nsInfo.isLastPage || maxPage <= pageNumber){
            let tomato = [];            
            nsRepo.getMosaicsNames(mosaicIds).subscribe((mosaicNames) => {
              mosaicNames.forEach((mosaic) => {
                if(mosaic.names.length > 0){
                  let names = mosaic.names[0].name.split('.');
                  if(names[1] === 'tomato'){
                    console.log(mosaic.names[0].name);
                    const labelName = mosaic.names[0].name;
                    const color = getColor(old);
                    old = color;
                    tomato.push(
                      {
                        label: labelName,
                        data: [0],
                        backgroundColor: color.backgroundColor,
                        borderColor: color.borderColor,
                        fill: false,
                      }
                    );
                    graphArray.push({name: labelName, mosaic_id: mosaic.mosaicId.toHex(), count: 0});
                  }
                }
              });
              drawChart(tomato);
            });
            clearInterval(timer);
          }
        },2000);
      }

      function getColor(){
        if(useColors.length === colors.length){
          useColors = [];
        }
        const color = colors[Math.floor(Math.random() * colors.length)];
        const use = useColors.find((useColor) => useColor.id === color.id);
        if(use){
          return getColor();
        }
        useColors.push(color);
        return color;
      }

      getTomatoNamespace();
      
      //åˆå›å®Ÿè¡Œ
      getBatchOfTransfers();
      getTomatoUser();
      getToshiTomatoUser();
      getTomatoUserList();

      setInterval( function(){
        getBatchOfTransfers();
        getTomatoUser();
        getToshiTomatoUser();
        getTomatoUserList();
      }, 60000 * updatetime); //3åˆ†æ¯

      listener.open().then(() => {
        console.log('listner open')
        listener.newBlock().subscribe((block) => {
          if(init){
            updateChart(block);
          }
        });

        listener.webSocket.onclose = function(){
          console.log("listener onclose");
        }
        listenNewBlock();
      });

      function listenNewBlock(){
        listener.newBlock();
        console.log("listenNewBlock");
        setTimeout(listenNewBlock, 50000);
      }
    })();
  </script>
</body>
</html>